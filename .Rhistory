df.use <- df %>%
select(names(.)[str_detect(names(.), v1.gr) | str_detect(names(.), v2.gr)]) %>%
filter(rowSums(.) > 0)
print(df.use)
group.list <- gsub("\\_\\d+$", "", names(df.use))
print(str_c(group.list, collapse = "    "))
# deseq
colData <- data.frame(row.names=colnames(df.use),
group_list=factor(group.list, levels = c(v1.gr, v2.gr)))
print(colData)
print(str_c(colnames(df.use), collapse = "    "))
dds <- DESeqDataSetFromMatrix(countData = df.use,
colData = colData,
design = ~ group_list)
dds <- DESeq(dds)
res <- as.data.frame(results(dds, contrast=c("group_list",v1.gr, v2.gr)))
# drop NA
res <- res %>%
as.data.frame(.) %>%
filter(!is.na(padj)) %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
# plot VOL
res <- res %>% mutate(
stat =  case_when(
(padj <= p & log2FoldChange >= fc) ~ "up",
(padj <= p & log2FoldChange <= -fc) ~ "down",
TRUE ~ "None"
)
)
# marks table
# fc
label.fc <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = abs(log2FoldChange)) %>%
ungroup()
label.p <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = -padj)%>%
ungroup()
lable.df <- rbind(label.p, label.fc) %>% distinct()
p.vol <- ggplot(res, aes(log2FoldChange, -log10(padj), color = stat)) +
geom_point(size = 0.7) +
geom_label_repel(lable.df, mapping = aes(log2FoldChange, -log10(padj),label = gene),show.legend = F)+
scale_color_manual(values = c(up = "#F26522", down = "#00AEEF", None ="gray")) +
geom_hline(aes(yintercept=-log10(p)), linewidth = 1, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=-fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
ggtitle(str_glue("{v1.gr}.vs.{v2.gr}"))+
theme_bw() + plot_theme
res.out <- res %>%
select(gene_id, gene, log2FoldChange, padj, stat) %>%
mutate(log2FoldChange = round(log2FoldChange, 4),
padj  = round(padj, 4))
degs.all[[v1]] <- res %>% mutate(group = str_glue("{v1.gr}_vs_{v2.gr}"))
write_tsv(res.out,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.txt")
)
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.png"),
plot = p.vol,
device = "png",
width = 8,
height = 8)
use.genes <- res %>% filter(stat %in% c("up", "down")) %>% .$gene_id
count.data <- df.use[rownames(df.use) %in% use.genes, ]
count.data <- count.data %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
write_tsv(count.data,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_count.txt"))
write_tsv(lable.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_top.txt"))
}
degs.all.df <- do.call("rbind", degs.all)
degs.count.df <- degs.all.df %>%
group_by(group, stat) %>% summarise(ngenes = n()) %>%
filter(!stat %in% "None")
p <- ggplot(degs.count.df, aes(group, ngenes, fill = stat)) +
geom_bar(stat = "identity",
position = position_dodge(0.75),width = 0.75) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
write_tsv(degs.count.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_DEGs_count.txt"))
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_DEGs.png"),
plot = p,
device = "png",
width = 8,
height = 5)
degs.all <- list()
}
library(tidyverse)
library(DESeq2)
library(ggrepel)
#library(ComplexHeatmap)
dir.create(str_glue("out/deseq_tables/"),recursive = T)
dir.create(str_glue("out/deseq_plots/"), recursive = T)
plot_theme <-
theme_bw()+
theme(axis.title.x = element_text(size = 18),
axis.title.y = element_text(size = 18),
axis.text = element_text(size = 13,color = "black"))
df <- read.table("data/raw_gene.txt", header = T, row.names = 1)
gene.ann <- read.table("data/gene_symbol.txt", header = T)
AD.gr <- read_tsv("data/AD_gr.txt")
UB.gr <- read_tsv("data/UB_gr.txt")
p <- 0.05
fc <- 2
lable.num <- 10
for (ori in c("AD")) {
degs.all <- list()
# AD or UB
data.use <- ori
if (data.use == "AD") {
use <- AD.gr
}else if (data.use == "UB") {
use <- UB.gr
}
dir.create(str_glue("out/deseq_tables/{data.use}"))
dir.create(str_glue("out/deseq_plots/{data.use}"))
for (v1 in seq_along(use$col1)) {
v1.gr <- use[v1, 1]$col1
v2.gr <- use[v1, 2]$col2
df.use <- df %>%
select(names(.)[str_detect(names(.), v1.gr) | str_detect(names(.), v2.gr)]) %>%
filter(rowSums(.) > 0)
group.list <- gsub("\\_\\d+$", "", names(df.use))
print(str_c(group.list, collapse = "    "))
# deseq
colData <- data.frame(row.names=colnames(df.use),
group_list=factor(group.list, levels = c(v1.gr, v2.gr)))
print(colData)
print(str_c(colnames(df.use), collapse = "    "))
dds <- DESeqDataSetFromMatrix(countData = df.use,
colData = colData,
design = ~ group_list)
dds <- DESeq(dds)
res <- as.data.frame(results(dds, contrast=c("group_list",v1.gr, v2.gr)))
# drop NA
res <- res %>%
as.data.frame(.) %>%
filter(!is.na(padj)) %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
# plot VOL
res <- res %>% mutate(
stat =  case_when(
(padj <= p & log2FoldChange >= fc) ~ "up",
(padj <= p & log2FoldChange <= -fc) ~ "down",
TRUE ~ "None"
)
)
# marks table
# fc
label.fc <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = abs(log2FoldChange)) %>%
ungroup()
label.p <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = -padj)%>%
ungroup()
lable.df <- rbind(label.p, label.fc) %>% distinct()
p.vol <- ggplot(res, aes(log2FoldChange, -log10(padj), color = stat)) +
geom_point(size = 0.7) +
geom_label_repel(lable.df, mapping = aes(log2FoldChange, -log10(padj),label = gene),show.legend = F)+
scale_color_manual(values = c(up = "#F26522", down = "#00AEEF", None ="gray")) +
geom_hline(aes(yintercept=-log10(p)), linewidth = 1, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=-fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
ggtitle(str_glue("{v1.gr}.vs.{v2.gr}"))+
theme_bw() + plot_theme
res.out <- res %>%
select(gene_id, gene, log2FoldChange, padj, stat) %>%
mutate(log2FoldChange = round(log2FoldChange, 4),
padj  = round(padj, 4))
degs.all[[v1]] <- res %>% mutate(group = str_glue("{v1.gr}_vs_{v2.gr}"))
write_tsv(res.out,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.txt")
)
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.png"),
plot = p.vol,
device = "png",
width = 8,
height = 8)
use.genes <- res %>% filter(stat %in% c("up", "down")) %>% .$gene_id
count.data <- df.use[rownames(df.use) %in% use.genes, ]
count.data <- count.data %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
write_tsv(count.data,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_count.txt"))
write_tsv(lable.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_top.txt"))
}
degs.all.df <- do.call("rbind", degs.all)
degs.count.df <- degs.all.df %>%
group_by(group, stat) %>% summarise(ngenes = n()) %>%
filter(!stat %in% "None")
p <- ggplot(degs.count.df, aes(group, ngenes, fill = stat)) +
geom_bar(stat = "identity",
position = position_dodge(0.75),width = 0.75) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
write_tsv(degs.count.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_DEGs_count.txt"))
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_DEGs.png"),
plot = p,
device = "png",
width = 8,
height = 5)
degs.all <- list()
}
library(tidyverse)
library(DESeq2)
library(ggrepel)
#library(ComplexHeatmap)
dir.create(str_glue("out/deseq_tables/"),recursive = T)
dir.create(str_glue("out/deseq_plots/"), recursive = T)
plot_theme <-
theme_bw()+
theme(axis.title.x = element_text(size = 18),
axis.title.y = element_text(size = 18),
axis.text = element_text(size = 13,color = "black"))
df <- read.table("data/raw_gene.txt", header = T, row.names = 1)
gene.ann <- read.table("data/gene_symbol.txt", header = T)
AD.gr <- read_tsv("data/AD_gr.txt")
UB.gr <- read_tsv("data/UB_gr.txt")
p <- 0.05
fc <- 2
lable.num <- 10
for (ori in c("UB")) {
degs.all <- list()
# AD or UB
data.use <- ori
if (data.use == "AD") {
use <- AD.gr
}else if (data.use == "UB") {
use <- UB.gr
}
dir.create(str_glue("out/deseq_tables/{data.use}"))
dir.create(str_glue("out/deseq_plots/{data.use}"))
for (v1 in seq_along(use$col1)) {
v1.gr <- use[v1, 1]$col1
v2.gr <- use[v1, 2]$col2
df.use <- df %>%
select(names(.)[str_detect(names(.), v1.gr) | str_detect(names(.), v2.gr)]) %>%
filter(rowSums(.) > 0)
group.list <- gsub("\\_\\d+$", "", names(df.use))
print(str_c(group.list, collapse = "    "))
# deseq
colData <- data.frame(row.names=colnames(df.use),
group_list=factor(group.list, levels = c(v1.gr, v2.gr)))
print(colData)
print(str_c(colnames(df.use), collapse = "    "))
dds <- DESeqDataSetFromMatrix(countData = df.use,
colData = colData,
design = ~ group_list)
dds <- DESeq(dds)
res <- as.data.frame(results(dds, contrast=c("group_list",v1.gr, v2.gr)))
# drop NA
res <- res %>%
as.data.frame(.) %>%
filter(!is.na(padj)) %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
# plot VOL
res <- res %>% mutate(
stat =  case_when(
(padj <= p & log2FoldChange >= fc) ~ "up",
(padj <= p & log2FoldChange <= -fc) ~ "down",
TRUE ~ "None"
)
)
# marks table
# fc
label.fc <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = abs(log2FoldChange)) %>%
ungroup()
label.p <- res %>%
filter(stat %in% c("up", "down")) %>%
group_by(stat) %>%
top_n(round(lable.num/2, 0),wt = -padj)%>%
ungroup()
lable.df <- rbind(label.p, label.fc) %>% distinct()
p.vol <- ggplot(res, aes(log2FoldChange, -log10(padj), color = stat)) +
geom_point(size = 0.7) +
geom_label_repel(lable.df, mapping = aes(log2FoldChange, -log10(padj),label = gene),show.legend = F)+
scale_color_manual(values = c(up = "#F26522", down = "#00AEEF", None ="gray")) +
geom_hline(aes(yintercept=-log10(p)), linewidth = 1, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
geom_vline(aes(xintercept=-fc), linewidth = 0.5, linetype="dashed", color = "gray70") +
ggtitle(str_glue("{v1.gr}.vs.{v2.gr}"))+
theme_bw() + plot_theme
res.out <- res %>%
select(gene_id, gene, log2FoldChange, padj, stat) %>%
mutate(log2FoldChange = round(log2FoldChange, 4),
padj  = round(padj, 4))
degs.all[[v1]] <- res %>% mutate(group = str_glue("{v1.gr}_vs_{v2.gr}"))
write_tsv(res.out,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.txt")
)
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}.png"),
plot = p.vol,
device = "png",
width = 8,
height = 8)
use.genes <- res %>% filter(stat %in% c("up", "down")) %>% .$gene_id
count.data <- df.use[rownames(df.use) %in% use.genes, ]
count.data <- count.data %>%
mutate(gene_id = rownames(.)) %>%
left_join(gene.ann, by = "gene_id")
write_tsv(count.data,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_count.txt"))
write_tsv(lable.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_{v1.gr}_vs_{v2.gr}_top.txt"))
}
degs.all.df <- do.call("rbind", degs.all)
degs.count.df <- degs.all.df %>%
group_by(group, stat) %>% summarise(ngenes = n()) %>%
filter(!stat %in% "None")
p <- ggplot(degs.count.df, aes(group, ngenes, fill = stat)) +
geom_bar(stat = "identity",
position = position_dodge(0.75),width = 0.75) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
write_tsv(degs.count.df,
str_glue("out/deseq_tables/{data.use}/{data.use}_DEGs_count.txt"))
ggsave(filename = str_glue("out/deseq_plots/{data.use}/{data.use}_DEGs.png"),
plot = p,
device = "png",
width = 8,
height = 5)
degs.all <- list()
}
library(UpSetR)
library(tidyverse)
library(patchwork)
AD.gr <- read_tsv("data/AD_gr.txt")
UB.gr <- read_tsv("data/UB_gr.txt")
dir.create("out/upsets/tables/",recursive = T)
dir.create("out/upsets/tables/AD",recursive = T)
dir.create("out/upsets/tables/UB",recursive = T)
get.unique.genes <- function(df, colname) {
df <- df %>% as_tibble()
f <- rowSums(df %>% filter(across(all_of(colname)) == 1) %>% dplyr::select_if(is.numeric)) == 1
df.out <- df %>% filter(across(all_of(colname)) == 1)
return(df.out[f,])
}
for (use.gr in c("AD", "UB")) {
dir.create(str_glue("./out/upsets/{use.gr}/"))
if (use.gr == "AD") {
use <- AD.gr
}else{
use <- UB.gr
}
exp.all <- list()
use.cols <- c()
for (v1 in seq_along(use$col1)) {
v1.gr <- use[v1, 1]$col1
v2.gr <- use[v1, 2]$col2
df.use <- read_tsv(str_glue("out/deseq_tables/{use.gr}/{use.gr}_{v1.gr}_vs_{v2.gr}.txt"))
use.cols <- append(use.cols, str_glue("{v1.gr}_vs_{v2.gr}"))
df.use <- df.use %>% filter(!stat %in% "None") %>%
mutate(is_use = 1, group = str_glue("{v1.gr}_vs_{v2.gr}"))
exp.all[[v1]] <- df.use
}
all.df <- do.call("rbind", exp.all) %>%
dplyr::select(-log2FoldChange, -padj, -gene_id) %>%
spread(key = group, value = is_use )
all.df[is.na(all.df)] <- 0
write_tsv(all.df, str_glue("out/upsets/tables/{use.gr}_DEGs_table.txt"))
all.df$name <- str_c(all.df$gene, "_", all.df$stat)
all.df <- all.df %>%  column_to_rownames("name")
p <- upset(data = all.df, point.size = 2,
sets = use.cols,
main.bar.color = "#00AEEF",
queries = list(
list(
query = elements, params = list("stat", "up"),color = c("#F26522"),active = T
)
)
)
pdf.name <- str_glue("out/upsets/{use.gr}/{use.gr}_DEGs_upsets.pdf")
pdf(file = pdf.name,height=5,width=10)
print (p)
dev.off()
# unique genes
for (v1 in seq_along(use$col1)) {
v1.gr <- use[v1, 1]$col1
v2.gr <- use[v1, 2]$col2
uniqu.gene.df <- get.unique.genes(all.df, str_glue("{v1.gr}_vs_{v2.gr}"))[,c("gene", "stat")]
write_tsv(uniqu.gene.df,str_glue("./out/upsets/tables/{use.gr}/{use.gr}_{v1.gr}_vs_{v2.gr}_DEGs_unique.txt"))
}
}
library(ggVennDiagram)
library(tidyverse)
dir.create("out/veen_AD_UB/plot/", recursive = T)
dir.create("out/veen_AD_UB/tables/", recursive = T)
make.degs.vene <- function(f1, f2, name1, name2) {
df1 <- read_tsv(f1)
df2 <- read_tsv(f2)
out.list <- list()
#df1.up <- df1 %>% filter(stat == "up") %>% .$gene
#df2.up <- df2 %>% filter(stat == "up") %>% .$gene
#df1.down <- df1 %>% filter(stat == "down") %>% .$gene
#df2.down <- df2 %>% filter(stat == "down") %>% .$gene
df1.all <- df1 %>% mutate(group = name1) %>% filter(stat %in% c("down", "up")) #%>% .$gene
df2.all <- df2 %>% mutate(group = name2) %>% filter(stat %in% c("down", "up")) #%>% .$gene
# up veen
up.list <- list()
up.list[[name1]] <- df1.all$gene
up.list[[name2]] <- df2.all$gene
p.all <- ggVennDiagram(up.list,edge_size = 1, set_size = 3)+
scale_fill_distiller(palette = "RdBu")+
scale_color_manual(values = c(rep("black",3)))
# save data
comm.genes <- intersect(df1.all$gene, df2.all$gene)
print(comm.genes)
comm.df <- rbind(
df1.all %>% filter(gene %in% comm.genes),
df2.all %>% filter(gene %in% comm.genes)
)
uniq.df1 <- df1.all %>% filter(!gene %in% comm.genes)
uniq.df2 <- df2.all %>% filter(!gene %in% comm.genes)
# out
write_tsv(comm.df, str_glue("./out/veen_AD_UB/tables/common_{name1}_AND_{name2}.txt"))
write_tsv(uniq.df1, str_glue("./out/veen_AD_UB/tables/unique_{name1}.txt"))
write_tsv(uniq.df2, str_glue("./out/veen_AD_UB/tables/unique_{name2}.txt"))
return(p.all)
}
p1 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T10_T12_vs_AD_T3_T5.txt",
"out/deseq_tables/UB/UB_UB_T10_T12_vs_UB_T3_T5.txt",
"AD_T10_T12_vs_T3_T5",
"UB_T10_T12_vs_T3_T5"
)
p2 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T10_T12_vs_AD_T8.txt",
"out/deseq_tables/UB/UB_UB_T10_T12_vs_UB_T8.txt",
"AD_T10_T12_vs_T8",
"UB_T10_T12_vs_T8"
)
p3 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T3_T5_vs_AD_T8.txt",
"out/deseq_tables/UB/UB_UB_T3_T5_vs_UB_T8.txt",
"AD_T3_T5_vs_T8",
"UB_T3_T5_vs_T8"
)
library(ggVennDiagram)
library(tidyverse)
dir.create("out/veen_AD_UB/plot/", recursive = T)
dir.create("out/veen_AD_UB/tables/", recursive = T)
make.degs.vene <- function(f1, f2, name1, name2) {
df1 <- read_tsv(f1)
df2 <- read_tsv(f2)
out.list <- list()
#df1.up <- df1 %>% filter(stat == "up") %>% .$gene
#df2.up <- df2 %>% filter(stat == "up") %>% .$gene
#df1.down <- df1 %>% filter(stat == "down") %>% .$gene
#df2.down <- df2 %>% filter(stat == "down") %>% .$gene
df1.all <- df1 %>% mutate(group = name1) %>% filter(stat %in% c("down", "up")) #%>% .$gene
df2.all <- df2 %>% mutate(group = name2) %>% filter(stat %in% c("down", "up")) #%>% .$gene
# up veen
up.list <- list()
up.list[[name1]] <- df1.all$gene
up.list[[name2]] <- df2.all$gene
p.all <- ggVennDiagram(up.list,edge_size = 1, set_size = 3)+
scale_fill_distiller(palette = "RdBu")+
scale_color_manual(values = c(rep("black",3)))
# save data
comm.genes <- intersect(df1.all$gene, df2.all$gene)
print(comm.genes)
comm.df <- rbind(
df1.all %>% filter(gene %in% comm.genes),
df2.all %>% filter(gene %in% comm.genes)
)
uniq.df1 <- df1.all %>% filter(!gene %in% comm.genes)
uniq.df2 <- df2.all %>% filter(!gene %in% comm.genes)
# out
write_tsv(comm.df, str_glue("./out/veen_AD_UB/tables/common_{name1}_AND_{name2}.txt"))
write_tsv(uniq.df1, str_glue("./out/veen_AD_UB/tables/unique_{name1}.txt"))
write_tsv(uniq.df2, str_glue("./out/veen_AD_UB/tables/unique_{name2}.txt"))
return(p.all)
}
p1 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T10_T12_vs_AD_T3_T5.txt",
"out/deseq_tables/UB/UB_UB_T10_T12_vs_UB_T3_T5.txt",
"AD_T10_T12_vs_T3_T5",
"UB_T10_T12_vs_T3_T5"
)
p2 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T10_T12_vs_AD_T8.txt",
"out/deseq_tables/UB/UB_UB_T10_T12_vs_UB_T8.txt",
"AD_T10_T12_vs_T8",
"UB_T10_T12_vs_T8"
)
p3 <- make.degs.vene(
"out/deseq_tables/AD/AD_AD_T8_vs_AD_T3_T5.txt",
"out/deseq_tables/UB/UB_UB_T8_vs_UB_T3_T5.txt",
"AD_T8_vs_T3_T5",
"UB_T8_vs_T3_T5"
)
p <- list()
p[[1]] <- p1
p[[2]] <- p2
p[[3]] <- p3
p.out <- cowplot::plot_grid(plotlist = p,nrow = 3)
ggsave(filename = "out/veen_AD_UB/plot/veen.pdf",plot = p.out, width = 8, height = 8)
